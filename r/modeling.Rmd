---
title: "Modeling Simulation Data"
subtitle: "`r params$size` `r params$simulation`"
author: "Young Geun Kim"
date: "`r format(Sys.time(), '%d %b, %Y')`"
output: 
  bookdown::html_document2:
    toc: true
params:
  simulation:
    label: "Simulation model:"
    value: vhar
    choices: [vhar, var]
  size:
    label: "Simulation size:"
    value: medium
    choices: [small, medium, large]
  h:
    label: "Out of sample:"
    value: 20
    input: slider
    min: 5
    max: 100
    step: 5
  var_lag:
    label: "Lag of VAR:"
    value: 5
    input: slider
    min: 1
    max: 25
    step: 1
  bvar_del:
    label: "delta of BVAR:"
    value: .6
    input: numeric
  bvar_lam:
    label: "lambda of BVAR:"
    value: .2
    input: numeric
  bvar_lag:
    label: "Lag of BVAR"
    value: 5
    input: slider
    min: 1
    max: 25
    step: 1
  bvhar_del:
    label: "delta of BVHAR:"
    value: .6
    input: numeric
  bvhar_lam:
    label: "lambda of BVHAR:"
    value: .2
    input: numeric
  daily_del:
    label: "Daily delta:"
    value: .3
    input: numeric
  weekly_del:
    label: "Weekly delta:"
    value: .2
    input: numeric
  monthly_del:
    label: "Monthly delta:"
    value: .1
    input: numeric
  predplot_cut:
    label: "Prediction plot x label from:"
    value: 4500
    input: slider
    min: 1
    max: 5000
    step: 100
knit:
  (function(inputFile, encoding) {
    rmarkdown::render(
      input = inputFile,
      output_dir = "../docs/results", 
      params = "ask", 
      encoding = encoding
    )
  })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  fig.asp = .618,
  fig.pos = "H"
  )
knitr::knit_hooks$set(
  document = function(x) {
    sub("\\usepackage[]{color}", "\\usepackage{xcolor}", x, fixed = TRUE)
  }
)
options(digits = 3)
plot_cut <- params$predplot_cut
```

```{r}
library(tidyverse)
library(bvhar)
```

# Dataset

## Import

```{r, message=FALSE}
# Train data set----------------------------
tr_file <- 
  str_c(
    "../data/processed/",
    params$simulation,
    "sim"
  ) %>% 
  str_c(params$size, "train.csv", sep = "_")
# Test data set----------------------------
te_file <- 
  str_c(
    "../data/processed/",
    params$simulation,
    "sim"
  ) %>% 
  str_c(params$size, "test.csv", sep = "_")
# Import-----------------------------------
y_train <- read_csv(tr_file)
y_test <- read_csv(te_file)
num_test <- params$h
y_test <- 
  y_test %>% 
  slice(1:num_test)
```

```{r, echo=FALSE}
y_train %>% 
  mutate(train = TRUE) %>% 
  bind_rows(y_test %>% mutate(train = FALSE)) %>% 
  mutate(id = 1:n()) %>% 
  pivot_longer(-c(id, train), names_to = "asset", values_to = "value") %>% 
  ggplot(aes(x = id, y = value)) +
  # geom_path(aes(colour = train), show.legend = FALSE) +
  # facet_grid(asset ~ ., scales = "free_y") +
  annotate(
    geom = "rect",
    xmin = nrow(y_train),
    xmax = Inf,
    ymin = -Inf,
    ymax = Inf,
    alpha = .7,
    fill = "grey" # test set
  ) +
  geom_path(aes(colour = asset), show.legend = FALSE, alpha = .7) +
  # scale_colour_viridis_d() +
  theme_minimal() +
  labs(
    x = element_blank(),
    y = element_blank()
  )
```

# Models

## VAR

```{r}
(var_lag <- params$var_lag)
```

```{r}
fit_var <- var_lm(y_train, var_lag)
pred_var <- predict(fit_var, num_test)
(mse_var <- mse(pred_var, y_test))
```

## VHAR

```{r}
fit_vhar <- vhar_lm(y_train)
pred_vhar <- predict(fit_vhar, num_test)
(mse_vhar <- mse(pred_vhar, y_test))
```

## BVAR

### Shrinkage hyperparameter

```{r}
(lam <- params$bvar_lam)
```

### delta

White noise ($\delta_i = 0$) versus random walk ($\delta_i = 1$, Litterman):

```{r}
(del <- rep(params$bvar_del, ncol(y_train)))
```

### sigma

$\Sigma_e = diag(\sigma_1, \ldots, \sigma_m)$: use sd of each variable.

```{r}
(sig <- apply(y_train, 2, sd))
```

### fit

```{r}
(bvar_lag <- params$bvar_lag)
```

```{r}
fit_bvar <- bvar_minnesota(y_train, bvar_lag, sig, lam, del)
pred_bvar <- predict(fit_bvar, num_test)
(mse_bvar <- mse(pred_bvar, y_test))
```

## BVHAR

### Shrinkage hyperparameter

```{r}
(lam_bvhar <- params$bvhar_lam)
```

### delta

White noise ($\delta_i = 0$) versus random walk ($\delta_i = 1$, Litterman):

```{r}
(del_bvhar <- rep(params$bvhar_del, ncol(y_train)))
```

### sigma

$\Sigma_e = diag(\sigma_1, \ldots, \sigma_m)$: use sd of each variable.

```{r}
(sig_bvhar <- apply(y_train, 2, sd))
```

### VAR-type BVHAR

```{r}
fit_bvhar_v1 <- bvhar_minnesota(
  y_train,
  type = "VAR",
  sigma = sig_bvhar,
  lambda = lam_bvhar,
  delta = del_bvhar,
  eps = 1e-04
)
pred_bvhar_v1 <- predict(fit_bvhar_v1, num_test)
(mse_bvhar_v1 <- mse(pred_bvhar_v1, y_test))
```

### For HAR-type BVHAR

$\delta_i$ for every daily, weekly, monthly matrix

```{r}
(daily <- rep(params$daily_del, ncol(y_train)))
(weekly <- rep(params$weekly_del, ncol(y_train)))
(monthly <- rep(params$monthly_del, ncol(y_train)))
```

### HAR-type BVHAR

```{r}
fit_bvhar_v2 <- bvhar_minnesota(
  y_train,
  type = "VHAR",
  sigma = sig_bvhar,
  lambda = lam_bvhar,
  daily = daily,
  weekly = weekly,
  monthly = monthly,
  eps = 1e-04
)
pred_bvhar_v2 <- predict(fit_bvhar_v2, num_test)
(mse_bvhar_v2 <- mse(pred_bvhar_v2, y_test))
```

## Compare

### Plot

```{r}
autoplot(pred_var, x_cut = plot_cut, ci_alpha = .6, type = "wrap") +
  # autolayer(pred_vhar, ci_alpha = .5) +
  autolayer(pred_bvar, ci_alpha = .4) +
  # autolayer(pred_bvhar_v1, ci_alpha = .3) +
  autolayer(pred_bvhar_v2, ci_alpha = .2) +
  theme(legend.position = "bottom") +
  scale_colour_viridis_d() +
  scale_fill_viridis_d()
```

### Mean of mse

Every variable:

```{r}
list(
  VAR = pred_var,
  VHAR = pred_vhar,
  BVAR = pred_bvar,
  BVHAR1 = pred_bvhar_v1,
  BVHAR2 = pred_bvhar_v2
) %>% 
  lapply(function(PRED) mse(PRED, y = y_test) %>% mean()) %>% 
  unlist() %>% 
  sort()
```

Average over *key variables*, i.e. first 5 ones:

```{r}
list(
  VAR = pred_var,
  VHAR = pred_vhar,
  BVAR = pred_bvar,
  BVHAR1 = pred_bvhar_v1,
  BVHAR2 = pred_bvhar_v2
) %>% 
  lapply(function(PRED) mse(PRED, y = y_test)[1:5] %>% mean()) %>% 
  unlist() %>% 
  sort()
```

### Each variable

```{r}
list(
  pred_var,
  pred_vhar,
  pred_bvar,
  pred_bvhar_v1,
  pred_bvhar_v2
) %>% 
  plot_loss(y = y_test) +
  # scale_y_log10() +
  theme_minimal()
```


