---
title: "Simulation"
author: "Young Geun Kim"
date: "`r format(Sys.time(), '%d %b, %Y')`"
output: 
  bookdown::html_document2:
    toc: true
params:
  size:
    label: "Simulation size:"
    value: small
    choices: [small, medium, large]
knit:
  (function(inputFile, encoding) {
    rmarkdown::render(
      input = inputFile,
      output_dir = "../output", 
      params = "ask", 
      encoding = encoding
    )
  })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  fig.asp = .618
)
knitr::knit_hooks$set(
  document = function(x) {
    sub("\\usepackage[]{color}", "\\usepackage{xcolor}", x, fixed = TRUE)
  }
)
options(digits = 3)
options(knitr.kable.NA = "")
options(kableExtra.latex.load_packages = FALSE)
is_html <- knitr::opts_knit$get("rmarkdown.pandoc.to") == "html"
is_latex <- knitr::opts_knit$get("rmarkdown.pandoc.to") == "latex"
kable_format <- ifelse(!is_html, "latex", "html")
kable_format <- ifelse(length(kable_format) == 0, "html", kable_format) # for excecutable
```

```{r pkgs, message=FALSE}
# tidyverse----------------------------
library(tidyverse)
# BVHAR custom package-----------------
library(bvhar)
# set seed for reproducible result-----
set.seed(1)
# out of sample------------------------
h_step <- 10
```

```{r fns, message=FALSE}
# result table-------------------------
source("report-fns.R")
# hyperparameter setting table---------
source("param-fns.R")
```

# SMALL

## Import

```{r, message=FALSE}
# Train data set----------------------------
tr_file <- 
  str_c(
    "../data/processed/",
    "vhar",
    "sim"
  ) %>% 
  str_c(params$size, "train.csv", sep = "_")
# Test data set----------------------------
te_file <- 
  str_c(
    "../data/processed/",
    "vhar",
    "sim"
  ) %>% 
  str_c(params$size, "test.csv", sep = "_")
# Import-----------------------------------
# Train set
y_train <- read_csv(tr_file)
# Evaluation set
y_test <- 
  read_csv(te_file) %>% 
  slice(1:30)
```

## Plot

```{r tsplot, echo=FALSE}
y_train %>% 
  mutate(train = TRUE) %>% 
  bind_rows(y_test %>% mutate(train = FALSE)) %>% 
  mutate(id = 1:n()) %>% 
  pivot_longer(-c(id, train), names_to = "asset", values_to = "value") %>% 
  ggplot(aes(x = id, y = value)) +
  annotate(
    geom = "rect",
    xmin = nrow(y_train),
    xmax = nrow(y_train) + nrow(y_test),
    ymin = -Inf,
    ymax = Inf,
    alpha = .7,
    fill = "grey" # test set
  ) +
  # geom_path(aes(colour = asset), show.legend = FALSE, alpha = .5) +
  geom_path() +
  facet_grid(asset ~ ., scales = "free_y") +
  scale_colour_viridis_d() +
  theme_minimal() +
  labs(
    x = element_blank(),
    y = element_blank()
  )
```

## Modeling

### VAR

```{r}
(var_lag <- 2)
```

```{r}
fit_var <- var_lm(y_train, var_lag, include_mean = FALSE)
pred_var <- predict(fit_var, h_step)
```

### VHAR

```{r}
fit_vhar <- vhar_lm(y_train, include_mean = FALSE)
pred_vhar <- predict(fit_vhar, h_step)
```

### BVAR

```{r}
(bvar_lag <- 2)
```

```{r}
(bvar_spec <- set_bvar(
  sigma = apply(y_train, 2, sd),
  lambda = .5,
  delta = rep(.1, ncol(y_train)),
  eps = 1e-04
))
```

```{r, cache=TRUE}
(bvar_optim <- choose_bvar(
  bvar_spec, 
  lower = c(
    rep(1e-9, ncol(y_train)), # sigma
    .01, # lambda
    rep(.01, ncol(y_train)) # delta
  ), 
  upper = c(
    rep(1, ncol(y_train)), # sigma
    2, # lambda
    rep(1, ncol(y_train)) # delta
  ), 
  y = y_train, 
  p = bvar_lag, 
  include_mean = FALSE
))
```

```{r}
fit_bvar <- bvar_optim$fit
bvar_summary <- summary(fit_bvar)
pred_bvar <- predict(fit_bvar, h_step)
```

```{r residplot}
autoplot(fit_bvar, alpha = .5)
```

```{r bvarcoefplot}
autoplot(bvar_summary, var_name = "asset_01")
```

### BVHAR-VAR

```{r}
(bvhar_spec <- set_bvhar(
  sigma = apply(y_train, 2, sd),
  lambda = .5,
  delta = rep(.1, ncol(y_train)),
  eps = 1e-04
))
```

```{r, cache=TRUE}
(bvhar_var_optim <- choose_bvhar(
  bvhar_spec, 
  lower = c(
    rep(1e-7, ncol(y_train)), # sigma
    .01, # lambda
    rep(.01, ncol(y_train)) # delta
  ), 
  upper = c(
    rep(1, ncol(y_train)), # sigma
    2, # lambda
    rep(1, ncol(y_train)) # delta
  ), 
  y = y_train, 
  include_mean = FALSE
))
```

```{r}
fit_bvhar_var <- bvhar_var_optim$fit
bvhar_var_summary <- summary(fit_bvhar_var)
pred_bvhar_var <- predict(fit_bvhar_var, h_step)
```

```{r bvharcoefplot1}
autoplot(bvhar_var_summary, var_name = "asset_01", NCOL = 3)
```

### BVHAR-VHAR

```{r}
(bvhar_spec_vhar <- set_weight_bvhar(
  sigma = apply(y_train, 2, sd),
  lambda = .5,
  eps = 1e-04,
  daily = rep(.1, ncol(y_train)),
  weekly = rep(.1, ncol(y_train)),
  monthly = rep(.1, ncol(y_train))
))
```

```{r, cache=TRUE}
(bvhar_vhar_optim <- choose_bvhar(
  bvhar_spec_vhar, 
  lower = c(
    rep(1e-7, ncol(y_train)), # sigma
    .01, # lambda
    rep(.01, ncol(y_train)), # daily
    rep(.01, ncol(y_train)), # weekly
    rep(.01, ncol(y_train)) # monthly
  ), 
  upper = c(
    rep(1, ncol(y_train)), # sigma
    2, # lambda
    rep(1, ncol(y_train)), # daily
    rep(1, ncol(y_train)), # weekly
    rep(1, ncol(y_train)) # monthly
  ), 
  y = y_train, 
  include_mean = FALSE
))
```

```{r}
fit_bvhar_vhar <- bvhar_vhar_optim$fit
bvhar_vhar_summary <- summary(fit_bvhar_vhar)
pred_bvhar_vhar <- predict(fit_bvhar_vhar, h_step)
```

```{r bvharcoefplot2}
autoplot(bvhar_vhar_summary, var_name = "asset_01", NCOL = 3)
```

### Errors

Noting the hyperparameters:

```{r}
list(
  bvar_optim$spec,
  bvhar_var_optim$spec,
  bvhar_vhar_optim$spec
) %>% 
  report_hyperparam(caption = "SMALL Simulation - Hyperparameter Lists", label = "hyperparamsmall") %>% 
  writeLines()
```

Out-of-forecasting:

```{r}
mod_list <- list(
  fit_var,
  fit_vhar,
  fit_bvar,
  fit_bvhar_var,
  fit_bvhar_vhar
)
# 1-step-----------
cv_list_1 <- 
  mod_list %>% 
  lapply(
    function(mod) {
      forecast_roll(mod, 1, y_test)
    }
  )
# 5-step-----------
cv_list_5 <- 
  mod_list %>% 
  lapply(
    function(mod) {
      forecast_roll(mod, 5, y_test)
    }
  )
# 20-step----------
cv_list_20 <- 
  mod_list %>% 
  lapply(
    function(mod) {
      forecast_roll(mod, 20, y_test)
    }
  )
```

```{r cvplot}
cv_list_5 %>% 
  gg_loss(y_test, mean_line = TRUE, mean_param = list(alpha = .5)) +
  theme_minimal() +
  theme(
    axis.text.x = ggplot2::element_text(angle = -30, vjust = -1),
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 7),
    legend.key.size = unit(.3, "cm")
  )
```

```{r, comment=NULL}
cv_list_5 %>% 
  get_losstex(y_test, "SMALL Simulation - 5-step ahead Rolling Window Forecasting Loss", label = "smallroll") %>% 
  writeLines()
```



