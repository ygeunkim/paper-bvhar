---
title: "Empirical Analysis"
author: "Young Geun Kim"
date: "`r format(Sys.time(), '%d %b, %Y')`"
output: 
  github_document:
    toc: true
knit:
  (function(inputFile, encoding) {
    rmarkdown::render(
      input = inputFile,
      output_dir = "../docs", 
      encoding = encoding
    )
  })
---

```{r etfdata}
etf_data <- "../data/processed/cboe_etf.rds"
```

```{r cacheset, include=FALSE, cache=TRUE, cache.extra = tools::md5sum(etf_data)}
knitr::opts_chunk$set(cache.rebuild = TRUE)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  out.width = "70%",
  fig.path = "../output/figs/analysis-",
  fig.align = "center",
  fig.width = 6,
  fig.asp = .618
)
knitr::knit_hooks$set(
  document = function(x) {
    sub("\\usepackage[]{color}", "\\usepackage{xcolor}", x, fixed = TRUE)
  }
)
options(digits = 3)
# options(scipen = -2) # scientific notation digits
options(knitr.kable.NA = "")
options(kableExtra.latex.load_packages = FALSE)
is_html <- knitr::opts_knit$get("rmarkdown.pandoc.to") == "html"
is_latex <- knitr::opts_knit$get("rmarkdown.pandoc.to") == "latex"
kable_format <- ifelse(!is_html, "latex", "html")
kable_format <- ifelse(length(kable_format) == 0, "html", kable_format) # for excecutable
```

```{r pkgs, message=FALSE}
# tidyverse----------------------------
library(tidyverse)
# BVHAR custom package-----------------
library(bvhar)
# Set the number of processor cores----
cl <- parallel::makeCluster(8, type = "FORK")
# set seed for reproducible result-----
set.seed(1)
# width of figure when save------------
fig_width <- 20
```

```{r fns, message=FALSE}
# result table-------------------------
source("report-fns.R")
# hyperparameter setting table---------
source("param-fns.R")
# CBOE ETF raw data--------------------
etf_raw <- readRDS(etf_data)
```

# Data

## Split

```{r testsize}
(h <- 30)
```

- 2000: Dot-com bubble
- 2001: September 11 terror and Enron scandal
- 2002: Stock market downturn after 2001
- 2003: Iraq war (until 2011)
- 2007 to 2008: Financial crisis
    - 2007: Subprime mortgage crisis
    - 2008: Bankruptcy of Lehman Brothers
- 2010 to 2016: European sovereign dept crisis
    - 2010: Greek debt crisis
    - 2011: *Italian default*
    - 2015: *Greek default*
    - 2016: Brexit
- 2018: US-China trade war
- 2019: Brexit
- 2020: COVID-19

```{r dataplot}
te_date <- tail(etf_raw$data_wide$date, h)[1]
data_plt <- 
  etf_raw$data_long %>% 
  mutate(
    train = date < te_date,
    series_id = str_remove_all(series_id, pattern = "CLS$"),
    xmin = min(date[train == FALSE]),
    xmax = max(date)
  ) %>% 
  ggplot(aes(x = date, y = value)) +
  geom_rect(
    aes(xmin = xmin, xmax = xmax, ymin = -Inf, ymax = Inf),
    alpha = .7,
    fill = "grey" # test set
  ) +
  geom_path() +
  facet_grid(series_id ~ ., scales = "free_y") +
  theme_minimal() +
  theme(
    panel.border = element_rect(fill = NA),
    # strip.text = element_text(size = 5),
    axis.text.y = element_text(size = 5)
  ) +
  labs(
    x = element_blank(),
    y = "Volatility index"
  )
data_plt
```

```{r savedataplot}
ggsave(
  filename = "../output/figs/analysis-dataplot.pdf", 
  plot = data_plt,
  device = "pdf",
  scale = .618,
  width = fig_width, 
  units = "in",
  dpi = 1500,
  limitsize = FALSE
)
```

```{r splittest}
etf_split <- 
  divide_ts(
    etf_vix %>% rename_with(~str_remove_all(., pattern = "CLS$")), 
    h
  )
etf_train <- etf_split$train
etf_test <- etf_split$test
```

## Long-range dependency

### Plot

ACF:

```{r gvzacf}
gvz_acf <- 
  etf_train %>% 
  select(GVZ) %>% 
  forecast::ggAcf(lag.max = 50) +
  theme_minimal() +
  theme(
    panel.border = element_rect(fill = NA),
    axis.text.y = element_text(size = 5),
    axis.text.x = element_text(size = 5)
  ) +
  labs(title = element_blank())
gvz_acf
```

```{r ovxacf}
ovx_acf <- 
  etf_train %>% 
  select(OVX) %>% 
  forecast::ggAcf(lag.max = 50) +
  theme_minimal() +
  theme(
    panel.border = element_rect(fill = NA),
    axis.text.y = element_text(size = 5),
    axis.text.x = element_text(size = 5)
  ) +
  labs(title = element_blank())
ovx_acf
```

Prewhitening for CCF:

```{r prewhitem, cache=TRUE}
gvz_ar <- forecast::Arima(etf_train$GVZ, order = c(30L, 0L, 0L), include.mean = FALSE, include.drift = FALSE)
ovx_ar <- forecast::Arima(etf_train$OVX, order = c(30L, 0L, 0L), include.mean = FALSE, include.drift = FALSE)
# prewhitening---------------
gvz_resid <- gvz_ar$residuals
ovx_resid <- ovx_ar$residuals
```

CCF:

```{r residccf}
resid_ccf <- 
  data.frame(
    Prewhitened_GVZ = gvz_resid,
    Prewhitened_OVX = ovx_resid
  ) %>% 
  forecast::ggAcf(lag.max = 50) +
  theme_minimal() +
  theme(
    panel.border = element_rect(fill = NA),
    axis.text.y = element_text(size = 5),
    axis.text.x = element_text(size = 5)
  ) +
  labs(title = element_blank())
resid_ccf
```

```{r saveacfplot}
# acf of GVZ---------------
ggsave(
  filename = "../output/figs/analysis-lrdacf-gvz.pdf", 
  plot = gvz_acf,
  device = "pdf",
  scale = .618,
  width = fig_width, 
  units = "in",
  dpi = 1500,
  limitsize = FALSE
)
# acf of OVX---------------
ggsave(
  filename = "../output/figs/analysis-lrdacf-ovx.pdf", 
  plot = ovx_acf,
  device = "pdf",
  scale = .618,
  width = fig_width, 
  units = "in",
  dpi = 1500,
  limitsize = FALSE
)
# ccf after prewhitening---
ggsave(
  filename = "../output/figs/analysis-lrdccf.pdf", 
  plot = resid_ccf,
  device = "pdf",
  scale = .618,
  width = fig_width, 
  units = "in",
  dpi = 1500,
  limitsize = FALSE
)
```



# Model

## VAR

```{r varic}
choose_var(etf_train, lag_max = 10)
```

```{r varlag}
(var_lag <- 3)
```

```{r fitvar}
fit_var <- var_lm(etf_train, var_lag)
```

## VHAR

```{r fitvhar}
fit_vhar <- vhar_lm(etf_train)
```

## BVAR

```{r bvarlag}
(bvar_lag <- var_lag)
```

```{r bvarinit}
n_asset <- ncol(etf_train)
bvar_init <- set_bvar(
  sigma = apply(etf_train, 2, sd),
  lambda = .2,
  delta = rep(.1, n_asset)
)
```

```{r bvaroptim, cache=TRUE}
(bvar_optim <- choose_bvar(
  bvar_init, 
  lower = c(
    rep(1, n_asset), # sigma
    1e-4, # lambda
    rep(1e-2, n_asset) # delta
  ), 
  upper = c(
    rep(15, n_asset), # sigma
    Inf, # lambda
    rep(1, n_asset) # delta
  ), 
  y = etf_train, 
  p = bvar_lag, 
  include_mean = TRUE,
  parallel = list(cl = cl, forward = FALSE, loginfo = FALSE)
))
```

```{r bvarfit}
fit_bvar <- bvar_optim$fit
```

## BVHAR-S

```{r bvharinit}
bvhar_init <- set_bvhar(
  sigma = apply(etf_train, 2, sd),
  lambda = .2,
  delta = rep(.1, n_asset)
)
```

```{r bvharvaroptim, cache=TRUE}
(bvhar_var_optim <- choose_bvhar(
  bvhar_init, 
  lower = c(
    rep(1, n_asset), # sigma
    1e-4, # lambda
    rep(1e-2, n_asset) # delta
  ), 
  upper = c(
    rep(15, n_asset), # sigma
    Inf, # lambda
    rep(1, n_asset) # delta
  ), 
  y = etf_train, 
  har = c(5, 22),
  include_mean = TRUE,
  parallel = list(cl = cl, forward = FALSE, loginfo = FALSE)
))
```

```{r bvharvarfit}
fit_bvhar <- bvhar_var_optim$fit
```

## BVHAR-L

```{r bvharvharinit}
bvhar_vhar_init <- set_weight_bvhar(
  sigma = apply(etf_train, 2, sd),
  lambda = .2,
  daily = rep(.1, n_asset),
  weekly = rep(.1, n_asset),
  monthly = rep(.1, n_asset)
)
```

```{r bvharvharoptim, cache=TRUE}
(bvhar_vhar_optim <- choose_bvhar(
  bvhar_vhar_init, 
  lower = c(
    rep(1, n_asset), # sigma
    1e-4, # lambda
    rep(1e-2, n_asset), # daily
    rep(1e-2, n_asset), # weekly
    rep(1e-2, n_asset) # monthly
  ), 
  upper = c(
    rep(15, n_asset), # sigma
    Inf, # lambda
    rep(1, n_asset), # daily
    rep(1, n_asset), # weekly
    rep(1, n_asset) # monthly
  ), 
  y = etf_train, 
  har = c(5, 22),
  include_mean = TRUE,
  parallel = list(cl = cl, forward = FALSE, loginfo = FALSE)
))
```

```{r bvharvharfit}
fit_bvhar_vhar <- bvhar_vhar_optim$fit
```

```{r stopcl}
parallel::stopCluster(cl)
```

## Hyperparamers


# Errors

```{r modroll}
mod_list <- list(
  fit_var,
  fit_vhar,
  fit_bvar,
  fit_bvhar,
  fit_bvhar_vhar
)
# 1-step-----------
roll1 <- 
  mod_list %>% 
  parallel::mclapply(
    function(mod) {
      forecast_roll(mod, 1, etf_test)
    },
    mc.cores = 4
  )
# 5-step-----------
roll2 <- 
  mod_list %>% 
  parallel::mclapply(
    function(mod) {
      forecast_roll(mod, 5, etf_test)
    },
    mc.cores = 4
  )
# 20-step----------
roll3 <- 
  mod_list %>% 
  parallel::mclapply(
    function(mod) {
      forecast_roll(mod, 20, etf_test)
    },
    mc.cores = 4
  )
```

```{r listroll}
roll_list <- 
  parallel::mclapply(
    c(1, 5, 20),
    function(h) {
      mod_list %>% 
        lapply(
          function(mod) {
            forecast_roll(mod, h, etf_test)
          }
        )
    },
    mc.cores = 8
  )
```


## Relative Errors

```{r relerror}
get_rmafetex_tr_2(
  roll_list, 
  etf_test, 
  ahead_list = c("$h = 1$", "$h = 5$", "$h = 20$"), 
  benchmark_id = 1,
  caption = "Out-of-sample forecasting performance measures with VAR(3) as benchmark", 
  label = "losscboe"
) %>% 
  writeLines()
```



```{r rmafetab}
get_rmfe_tr(
  roll_list,
  etf_test,
  ahead_list = c("$h = 1$", "$h = 5$", "$h = 20$"),
  benchmark_id = 1
)
```

```{r rmsfetab}
get_rmfe_tr(
  roll_list,
  etf_test,
  ahead_list = c("$h = 1$", "$h = 5$", "$h = 20$"),
  benchmark_id = 1,
  error = "rmsfe"
)
```

```{r mapetab}
get_rmfe_tr(
  roll_list,
  etf_test,
  ahead_list = c("$h = 1$", "$h = 5$", "$h = 20$"),
  benchmark_id = 1,
  error = "mape"
)
```

```{r masetab}
get_rmfe_tr(
  roll_list,
  etf_test,
  ahead_list = c("$h = 1$", "$h = 5$", "$h = 20$"),
  benchmark_id = 1,
  error = "mase"
)
```

## Piecewise Errors

```{r piecewise-error}
err_plt <- 
  roll_list[[1]] %>% 
  gg_loss(
    etf_test, 
    mean_line = TRUE, 
    line_param = list(size = .3), 
    mean_param = list(alpha = .5, size = .3)
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = -45, vjust = -1, size = 6),
    panel.border = element_rect(fill = NA),
    legend.position = "top"
  ) +
  scale_colour_viridis_d(labels = c("BVAR", "BVHAR-S", "BVHAR-L", "VAR", "VHAR"))
err_plt
```

```{r savepiecewise-error}
ggsave(
  filename = "../output/figs/analysis-piecewise-error.pdf", 
  plot = err_plt,
  device = "pdf",
  scale = .618,
  width = fig_width, 
  units = "in",
  dpi = 1500,
  limitsize = FALSE
)
```


# Intervals

```{r predictclass}
pred_var <- predict(fit_var, h)
pred_vhar <- predict(fit_vhar, h)
pred_bvar <- predict(fit_bvar, h)
pred_bvhar <- predict(fit_bvhar, h)
pred_bvhar_vhar <- predict(fit_bvhar_vhar, h)
```

<!-- ```{r credplot} -->
<!-- autoplot(pred_var, x_cut = 850, ci_alpha = .8, type = "wrap") + -->
<!--   autolayer(pred_vhar, ci_alpha = .7) + -->
<!--   autolayer(pred_bvar, ci_alpha = .6) + -->
<!--   autolayer(pred_bvhar, ci_alpha = .5) + -->
<!--   autolayer(pred_bvhar_vhar, ci_alpha = .4) + -->
<!--   geom_eval(etf_test, num_train = nrow(etf_train), alpha = .5) + -->
<!--   theme_minimal() + -->
<!--   theme( -->
<!--     panel.border = element_rect(fill = NA), -->
<!--     axis.text.x = element_blank(), -->
<!--     legend.position = "top" -->
<!--   ) + -->
<!--   scale_fill_discrete(labels = c("BVAR", "BVHAR-S", "BVHAR-L", "VAR", "VHAR")) -->
<!-- ``` -->

```{r credplot}
interval_plt <- 
  autoplot(pred_var, x_cut = 860, ci_alpha = .8, type = "wrap") +
  autolayer(pred_vhar, ci_alpha = .7) +
  autolayer(pred_bvar, ci_alpha = .6) +
  autolayer(pred_bvhar, ci_alpha = .5) +
  autolayer(pred_bvhar_vhar, ci_alpha = .4) +
  geom_eval(etf_test, num_train = nrow(etf_train), alpha = .5) +
  theme_minimal() +
  theme(
    panel.border = element_rect(fill = NA),
    axis.text.x = element_blank(),
    legend.position = "top"
  ) +
  scale_fill_viridis_d(labels = c("BVAR", "BVHAR-S", "BVHAR-L", "VAR", "VHAR"))
interval_plt
```

```{r savecredplot}
ggsave(
  filename = "../output/figs/analysis-credplot.pdf", 
  plot = interval_plt,
  device = "pdf",
  scale = .618,
  width = fig_width, 
  units = "in",
  dpi = 1500,
  limitsize = FALSE
)
```



